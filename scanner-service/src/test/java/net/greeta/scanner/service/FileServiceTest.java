package net.greeta.scanner.service;

import static org.junit.jupiter.api.Assertions.*;

import net.greeta.scanner.TestContext;
import net.greeta.scanner.config.MinioConfiguration;
import java.io.File;
import java.util.UUID;

import net.greeta.scanner.exception.VirusCheckExecutableFileException;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.kafka.test.context.EmbeddedKafka;
import org.springframework.test.context.ActiveProfiles;

@SpringBootTest
@ActiveProfiles("test")
@ExtendWith(TestContext.class)
@EmbeddedKafka(
    partitions = 1,
    brokerProperties = {"listeners=PLAINTEXT://localhost:9092", "port=9092"})
class FileServiceTest {
  @Autowired
  FileService fileService;
  @Autowired MinioService minioService;
  @Autowired MinioConfiguration minioConfiguration;
  File file = new File("test.mp4");
  String userId = UUID.randomUUID().toString();
  String fileId = UUID.randomUUID().toString();

  @BeforeEach
  void setUp() {}

  @AfterEach
  void tearDown() {}

  @Test
  void download() throws Exception {
    // prepare
    String path = "user/" + userId + "/" + file.getName();
    assertTrue(path.endsWith("mp4"));
    minioService.uploadObject(file, minioConfiguration.getStoreBucket(), path);
    // test
    fileService.download("minio.bucket.store://" + path, "download/" + fileId);
    File src = new File("download/" + fileId);
    src.deleteOnExit();
    assertTrue(src.exists());
  }

  @Test
  void scanExecutable() throws Exception {
    // prepare
    String path = "user/" + userId + "/" + file.getName();
    assertTrue(path.endsWith("mp4"));
    minioService.uploadObject(file, minioConfiguration.getStoreBucket(), path);
    fileService.download("minio.bucket.store://" + path, "download/" + fileId);
    File src = new File("download/" + fileId);
    src.deleteOnExit();
    try {
      fileService.scan(src);
      Assertions.fail("VirusCheckExecutableFileException should be thrown");
    } catch (VirusCheckExecutableFileException e) {
      //expected
    }
    // test

  }

  @Test
  void upload() throws Exception {
    // prepare
    String path = "user/" + userId + "/" + file.getName();
    assertTrue(path.endsWith("mp4"));
    minioService.uploadObject(file, minioConfiguration.getStoreBucket(), path);
    fileService.download("minio.bucket.store://" + path, "download/" + fileId);
    File src = new File("download/" + fileId);
    src.deleteOnExit();
    fileService.scan(src);
    // test
    fileService.upload(src, "user/" + userId + "/file/" + fileId + "/");
  }
}
